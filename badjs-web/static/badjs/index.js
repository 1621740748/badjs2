!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n((e=e||self)["wardjs-report"]={})}(this,function(e){"use strict";function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function t(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function o(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function r(e,n,t){return n&&o(e.prototype,n),t&&o(e,t),e}function c(e,n){return Object.prototype.toString.call(e)==="[object "+(n||"Object")+"]"}function l(e){return"object"===n(e)&&!!e}function i(e,n){for(var t in n)e[t]=n[t];return e}function m(e,n){return e.toString()===n.toString()}function s(e){var n=e.stack.replace(/\n/gi,"").split(/\bat\b/).slice(0,9).join("@").replace(/\?[^:]+/gi,""),t=e.toString();return n.indexOf(t)<0&&(n=t+"@"+n),n}var u={};function d(e,n){if(!l(e))return!0;var t=e.msg;return n<(u[t]=(parseInt(u[t],10)||0)+1)}var a,f=[],g=function(){function e(){t(this,e),this.db=null}return r(e,[{key:"getStore",value:function(){return this.db.transaction("logs","readwrite").objectStore("logs")}},{key:"ready",value:function(n){var t=this;if(!window.indexedDB)return n();if(this.db)setTimeout(function(){n(null,t)},0);else{var e=window.indexedDB.open("badjs",1);if(!e)return n();e.onerror=function(e){return n(e),!(this.offlineLog=!1)},e.onsuccess=function(e){t.db=e.target.result,setTimeout(function(){n(null,t)},500)},e.onupgradeneeded=function(e){var n=e.target.result;n.objectStoreNames.contains("logs")||n.createObjectStore("logs",{autoIncrement:!0})}}}},{key:"insertToDB",value:function(e){this.getStore().add(e)}},{key:"addLogs",value:function(e){if(this.db)for(var n=0;n<e.length;n++)this.insertToDB(e[n])}},{key:"getLogs",value:function(s,l){if(this.db){var e=this.getStore().openCursor(),f=[],c={},d=[],g={},p=[],v=0,h=0;e.onsuccess=function(e){var n=e.target.result;if(n&&n.value){if(n.value.time>=s.start&&n.value.time<=s.end&&m(n.value.id,s.id)&&m(n.value.uin,s.uin)){var t=n.value,o=t.from,r=t.level,i=t.msg,u=t.time,a=t.version;"number"!=typeof c[i]&&(d.push(i),c[i]=v++),"number"!=typeof g[o]&&(p.push(o),g[o]=h++),f.push({f:g[o],l:r,m:c[i],t:u,v:a})}n.continue()}else l(null,f,d,p)},e.onerror=function(e){return l(e),!0}}}},{key:"clearDB",value:function(e){if(this.db){var t=this.getStore();if(e){var o=Date.now()-24*(e||2)*3600*1e3;t.openCursor().onsuccess=function(e){var n=e.target.result;n&&(n.value.time<o||!n.value.time)&&(t.delete(n.primaryKey),n.continue())}}else t.clear()}}},{key:"save2Offline",value:function(e,n,t){n=i({id:t.id,uin:t.uin,time:new Date-0,version:t.version},n),this.db?this.insertToDB(n):(this.db||f.length||this.ready(function(e,n){e&&console.error(e),n&&f.length&&(n.addLogs(f),f=[])}),f.push(n))}}]),e}();function p(){return a||(a=new g)}function v(e,n,t){if(navigator.sendBeacon&&"function"==typeof navigator.sendBeacon)if("post"===t){var o=new FormData;o.append("offline_log",n),navigator.sendBeacon(e,o)}else navigator.sendBeacon(e,n);else!function(t,o,e){if("post"===e){var r=document.createElement("iframe");r.name="badjs_offline_"+(new Date-0),r.frameborder=0,r.height=0,r.width=0,r.src="javascript:false",r.onload=function(){var e=document.createElement("form");e.style.display="none",e.target=r.name,e.method="POST",e.action=t+"/offlineLog";var n=document.createElement("input");n.style.display="none",n.type="hidden",n.name="offline_log",n.value=o,r.contentDocument.body.appendChild(e),e.appendChild(n),e.submit(),console.log("report offline log success"),setTimeout(function(){document.body.removeChild(r),r=null},5e3),r.onload=null},document.body.appendChild(r)}else(new Image).src=t}(e,n,t)}var h=[],y=0,b=function(e){(clearTimeout(y),h.length)&&(v(e._reportUrl+h.join("&")+"&count="+h.length+"&_t="+ +new Date),y=0,h=[])},w=function(e,n,t){var o,r=[],i=[],u=[];if(l(e))for(var a in e.level=e.level||t.level,e){var s=e[a];if(null!==(o=s)&&(c(o,"Number")||o)){if(l(s))try{s=JSON.stringify(s)}catch(e){s="[BJ_REPORT detect value stringify error] "+e.toString()}u.push(a+":"+s),r.push(a+"="+encodeURIComponent(s)),i.push(a+"["+n+"]="+encodeURIComponent(s))}}return[i.join("&"),u.join(","),r.join("&")]},_=function(){function n(e){t(this,n),this.config=e}return r(n,[{key:"processLog",value:function(e,n){var t=this.config;if(t._reportUrl){for(var o=Math.random()>=t.random;e.length;){var r=!1,i=e.shift();if((!t.beforeReport||!1!==t.beforeReport(i))&&(i.msg=(i.msg+""||"").substr(0,t.maxLength),!d(i,t.repeat))){var u=w(i,h.length,t);if(c(t.ignore,"Array"))for(var a=0,s=t.ignore.length;a<s;a++){var l=t.ignore[a];if(c(l,"RegExp")&&l.test(u[1])||c(l,"Function")&&l(i,u[1])){r=!0;break}}if(!r){var f=p();t.offlineLog&&f.save2Offline("badjs_"+t.id+t.uin,i,t),o||20===i.level||(h.push(u[0]),t.onReport&&t.onReport(t.id,i))}}}n?b(t):y||(y=setTimeout(b.bind(null,t),t.delay))}}},{key:"reportOffline",value:function(e){var n=this.config,t=n.id,o=n.uin,r=n.url,i=navigator.userAgent,u=JSON.stringify(Object.assign(e,{userAgent:i,id:t,uin:o}));this.config.deflate&&window.pako&&(u=encodeURIComponent(window.pako.deflate(u,{to:"string"}))),v(r+"/offlineLog",u,"post")}}]),n}(),j=[],k={id:0,uin:0,url:"//now.qq.com/badjs",version:0,ext:null,level:4,ignore:[],random:1,delay:1e3,maxLength:500,submit:null,monitorUrl:"//report.url.cn/report/report_vm",repeat:5,offlineLog:!1,offlineLogExp:3,offlineLogAuto:!1,deflate:!1,onReport:function(){},beforeReport:function(){return!0}},O=function(){function n(e){t(this,n),this._initConfig(e),this.log=new _(k),this.offlineLog&&this._initOffline(),this._initError()}return r(n,[{key:"_initConfig",value:function(e){for(var n in k)n in e&&(k[n]=e[n]);var t=parseInt(k.id,10);for(var o in t&&(/qq\.com$/gi.test(location.hostname)&&(k.url||(k.url="//now.qq.com/badjs"),k.uin||(k.uin=parseInt((document.cookie.match(/\buin=\D+(\d+)/)||[])[1],10))),k._reportUrl=(k.url||"//now.qq.com/badjs")+"?id="+t+"&uin="+k.uin+"&version="+k.version+"&",v("".concat(k.url,"/").concat(t))),k)this[o]=k[o]}},{key:"_initOffline",value:function(){var t=this;return this.offlineDB=p(),this.offlineDB.ready(function(e,n){!e&&n&&setTimeout(function(){n.clearDB(t.offlineLogExp),setTimeout(function(){t.offlineLogAuto&&t._autoReportOffline()},5e3)},1e3)}),this}},{key:"_initError",value:function(){var u=window.onerror,a=this;window.onerror=function(e,n,t,o,r){var i=e;r&&r.stack&&(i=s(r)),c(i,"Event")&&(i+=i.type?"--"+i.type+"--"+(i.target?i.target.tagName+"::"+i.target.src:""):""),a._push({msg:i,target:n,rowNum:t,colNum:o,_orgMsg:e}),u&&u.apply(window,arguments)},"undefined"!=typeof console&&console.error&&setTimeout(function(){var e=((location.hash||"").match(/([#&])BJ_ERROR=([^&$]+)/)||[])[2];e&&console.error("BJ_ERROR",decodeURIComponent(e).replace(/(:\d+:\d+)\s*/g,"$1\n"))},0)}},{key:"_processLog",value:function(){var e=0<arguments.length&&void 0!==arguments[0]&&arguments[0];j.length&&(this.log.processLog(j,e),j=[])}},{key:"_push",value:function(e,n){var t=l(e)?function(n){try{if(n.stack){var e=n.stack.match("https?://[^\n]+"),t=(e=e?e[0]:"").match(":(\\d+):(\\d+)");return t||(t=[0,0,0]),{msg:s(n),rowNum:t[1],colNum:t[2],target:e.replace(t[0],""),_orgMsg:n.toString()}}return n.name&&n.message&&n.description?{msg:JSON.stringify(n)}:n}catch(e){return n}}(e):{msg:e};if(this.ext&&!t.ext&&(t.ext=this.ext),t.from||(t.from=location.href),t._orgMsg){delete t._orgMsg,t.level=2;var o=i({},t);o.level=4,o.msg=t.msg,j.push(t),j.push(o)}else j.push(t);return this._processLog(n),this}},{key:"report",value:function(e,n){return e&&this._push(e,n),this}},{key:"info",value:function(e){return e&&(l(e)?e.level=2:e={msg:e,level:2},this._push(e)),this}},{key:"debug",value:function(e){return e&&(l(e)?e.level=1:e={msg:e,level:1},this._push(e)),this}},{key:"addOfflineLog",value:function(e){return e&&(l(e)?e.level=20:e={msg:e,level:20},this._push(e)),this}},{key:"reportOfflineLog",value:function(a){if(window.indexedDB){var s=this;this.offlineDB.ready(function(e,n){if(!e&&n){var i=new Date-0-24*s.offlineLogExp*3600*1e3,u=new Date-0;n.getLogs({start:i,end:u,id:s.id,uin:s.uin},function(e,n,t,o){if(e)console.error(e);else{console.log("offline logs length:",n.length);var r={logs:n,msgObj:t,urlObj:o,startDate:i,endDate:u,secretKey:a};s.deflate?(window.pako?Promise.resolve():new Promise(function(e,n){var t=document.createElement("script");t.src="https://pub.idqqimg.com/29ee73ea8c294fce8498cb50503521d4.js",t.crossOrigin="anonymous",t.onload=e,t.onerror=n,document.getElementsByTagName("head")[0].appendChild(t)})).then(function(){s.log.reportOffline(r)}):s.log.reportOffline(r)}})}})}else this.info("unsupport offlineLog")}},{key:"_autoReportOffline",value:function(){var n=this,e=document.createElement("script");e.src="".concat(this.url,"/offlineAuto?id=").concat(this.id,"&uin=").concat(this.uin),window._badjsOfflineAuto=function(e){e&&n.reportOfflineLog(e)},document.head.appendChild(e)}}],[{key:"monitor",value:function(e){var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"//report.url.cn/report/report_vm";if(void 0!==e&&""!==e){void 0===e.join&&(e=[e]);var t={monitors:"["+e.join(",")+"]",_:Math.random()};if(n)v(n+(n.match(/\?/)?"&":"?")+function(e){var n=[];for(var t in e)e.hasOwnProperty(t)&&n.push(encodeURIComponent(t)+"="+encodeURIComponent(e[t]));return n.join("&")}(t))}}}]),n}();e.default=O,Object.defineProperty(e,"__esModule",{value:!0})});
